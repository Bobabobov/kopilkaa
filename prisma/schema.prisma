// prisma/schema.prisma
datasource db {
  provider = "sqlite" // если решишь перейти на Postgres — скажешь, переделаем URL/миграции
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  CONTEST
}

enum AchievementRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
  EXCLUSIVE
}

enum AchievementType {
  STREAK
  APPLICATIONS
  GAMES
  SOCIAL
  SPECIAL
  COMMUNITY
  CREATIVITY
}

model User {
  id                  String    @id @default(cuid())
  email               String?   @unique
  username            String?   @unique
  passwordHash        String
  name                String?
  avatar              String?
  avatarUpdatedAt     DateTime?
  phone               String?   @unique
  phoneVerified       Boolean   @default(false)
  telegramId          String?   @unique
  telegramUsername    String?
  googleId            String?   @unique
  googleEmail         String?
  vkLink              String?
  telegramLink        String?
  youtubeLink         String?
  headerTheme         String?   @default("default")
  headerThemeUpdatedAt DateTime?
  headerDominantColor String? // Доминантный цвет из обложки
  avatarFrame         String?   @default("none")
  customFrameData     String? // JSON данные пользовательских рамок
  // Ручной override для уникального HERO_BADGE (используется только для оплат > 5000).
  // Примеры значений: "custom" (или любое непустое значение как флаг).
  heroBadgeOverride   String?
  // Если true — пользователь скрыт из витрины /heroes (история поддержек не удаляется).
  hideFromHeroes      Boolean   @default(false)
  hideEmail           Boolean   @default(true) // Скрывать email в профиле по умолчанию
  role                String    @default("USER")
  createdAt           DateTime  @default(now())
  lastSeen            DateTime  @default(now())
  lastCommentAt       DateTime? // Время последнего комментария для кулдауна
  trustDelta          Int       @default(0)

  applications         Application[]
  userTree             UserTree?
  userAchievements     UserAchievement[]
  friendshipsSent      Friendship[]          @relation("FriendshipRequester")
  friendshipsReceived  Friendship[]          @relation("FriendshipReceiver")
  pageVisits           PageVisit[]
  storyLikes           StoryLike[]
  reportsSent          UserReport[]          @relation("ReportReporter")
  reportsReceived      UserReport[]          @relation("ReportReported")
  bugReports           BugReport[]           @relation("BugReportAuthor")
  bugReportLikes       BugReportLike[]       @relation("BugReportLikes")
  donations            Donation[]
  phoneLoginCodes      PhoneLoginCode[]
  projectNewsPosts     ProjectNewsPost[]
  projectNewsReactions ProjectNewsReaction[]
  reviews              Review[]
  gameScores           GameScore[]
  isBanned             Boolean               @default(false)
  bannedUntil          DateTime?
  bannedReason         String?
}

model Application {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title        String
  summary      String
  story        String
  amount       Int               @default(0)
  payment      String
  status       ApplicationStatus @default(PENDING)
  countTowardsTrust Boolean      @default(true)
  adminComment String?
  filledMs     Int?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  images ApplicationImage[]
  likes  StoryLike[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([updatedAt])
}

model ApplicationImage {
  id            String      @id @default(cuid())
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  url  String
  sort Int

  @@index([applicationId])
  @@index([sort])
}

// Модель для дерева мотивации
model UserTree {
  id           String    @id @default(cuid())
  userId       String    @unique
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  level        Int       @default(0)
  streak       Int       @default(0)
  maxStreak    Int       @default(0)
  totalWatered Int       @default(0)
  lastWatered  DateTime?
  treeType     String? // oak, sakura, etc.
  potType      String? // clay, ceramic, etc.
  background   String? // garden, forest, etc.
  decorations  String? // JSON array of decorations
  isCustomized Boolean   @default(false)
  customizedAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
}

// Модель для достижений
model Achievement {
  id          String            @id @default(cuid())
  slug        String?           @unique
  name        String
  description String
  icon        String
  rarity      AchievementRarity @default(COMMON)
  type        AchievementType   @default(SPECIAL)
  kind        AchievementKind   @default(NORMAL)
  isExclusive Boolean           @default(false)
  isHidden    Boolean           @default(false)
  isSeasonal  Boolean           @default(false)
  maxCount    Int               @default(1) // Максимальное количество раз, которое можно получить
  isActive    Boolean           @default(true)
  validFrom   DateTime? // Дата начала действия
  validTo     DateTime? // Дата окончания действия
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  userAchievements UserAchievement[]

  @@index([rarity])
  @@index([type])
  @@index([isActive])
  @@index([validFrom])
  @@index([validTo])
}

// Модель для связи пользователей с достижениями
model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  unlockedAt    DateTime    @default(now())
  grantedBy     String? // ID администратора, который выдал достижение
  grantedByName String? // Имя администратора для отображения

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([unlockedAt])
}

// Модель для дружбы между пользователями
model Friendship {
  id          String           @id @default(cuid())
  requesterId String
  requester   User             @relation("FriendshipRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  receiverId  String
  receiver    User             @relation("FriendshipReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  status      FriendshipStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([requesterId, receiverId])
  @@index([requesterId])
  @@index([receiverId])
  @@index([status])
  @@index([createdAt])
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  DECLINED
  BLOCKED
}

// Тип достижения: обычное или мета
enum AchievementKind {
  NORMAL
  META
}

enum DonationType {
  SUPPORT // входящий донат/подписка
  PAYOUT // вывод авторам (уменьшает копилку)
  ADJUST // ручная корректировка баланса
}

model Donation {
  id        String       @id @default(cuid())
  userId    String?
  user      User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  type      DonationType @default(SUPPORT)
  amount    Int // сумма в рублях (пока), >0
  comment   String?
  createdAt DateTime     @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model PhoneLoginCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}

// Модель для отслеживания времени на страницах
model PageVisit {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  page      String // путь страницы, например "/applications"
  timeSpent Int // время в миллисекундах
  visitDate DateTime @default(now())

  @@index([userId])
  @@index([page])
  @@index([visitDate])
}

// Модель для лайков историй
model StoryLike {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  createdAt     DateTime    @default(now())

  @@unique([userId, applicationId])
  @@index([userId])
  @@index([applicationId])
  @@index([createdAt])
}

enum ProjectNewsMediaType {
  IMAGE
  VIDEO
}

enum ProjectNewsReactionType {
  LIKE
  DISLIKE
}

enum ProjectNewsBadge {
  UPDATE
  PLANS
  THOUGHTS
  IMPORTANT
}

// Вспомогательная таблица для enum в SQLite - сохраняем, чтобы Prisma не удаляла её
// Эта таблица создаётся автоматически для enum ProjectNewsBadge в SQLite и содержит 4 записи
model ProjectNewsBadgeTable {
  value String @id

  @@map("ProjectNewsBadge")
}

model ProjectNewsPost {
  id       String @id @default(cuid())
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  title       String?
  badge       ProjectNewsBadge?
  content     String
  isPublished Boolean           @default(true)

  likesCount    Int @default(0)
  dislikesCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  media     ProjectNewsMedia[]
  reactions ProjectNewsReaction[]

  @@index([authorId])
  @@index([createdAt])
  @@index([isPublished])
}

model ProjectNewsMedia {
  id     String               @id @default(cuid())
  postId String
  post   ProjectNewsPost      @relation(fields: [postId], references: [id], onDelete: Cascade)
  url    String
  type   ProjectNewsMediaType
  sort   Int                  @default(0)

  @@index([postId])
  @@index([sort])
}

model ProjectNewsReaction {
  id     String          @id @default(cuid())
  postId String
  post   ProjectNewsPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String
  user   User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      ProjectNewsReactionType
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@index([type])
}

model Advertisement {
  id        String    @id @default(cuid())
  title     String
  content   String
  imageUrl  String?
  linkUrl   String?
  expiresAt DateTime?
  isActive  Boolean   @default(true)
  placement String    @default("home_sidebar") // home_sidebar, home_banner, stories, other
  config    Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([isActive])
  @@index([expiresAt])
  @@index([createdAt])
  @@index([placement])
}

model Review {
  id        String        @id @default(cuid())
  userId    String        @unique
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  content   String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  images    ReviewImage[]

  @@index([createdAt])
}

model ReviewImage {
  id       String  @id @default(cuid())
  reviewId String
  review   Review  @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  url      String
  sort     Int     @default(0)

  @@index([reviewId])
  @@index([sort])
}

// Модель для заявок на размещение рекламы
model AdRequest {
  id               String   @id @default(cuid())
  companyName      String // Название компании/проекта
  email            String // Контактный email
  telegram         String? // Telegram username
  website          String? // Ссылка на сайт/товар
  format           String // Формат размещения (banner, post, telegram)
  duration         Int // Срок в днях
  bannerUrl        String? // URL загруженного баннера (deprecated, используем imageUrls)
  imageUrls        Json? // Массив URL изображений (до 5 штук)
  mobileBannerUrls Json? // Массив URL изображений для мобильного баннера (только для format=banner, до 5 штук)
  comment          String? // Комментарий от рекламодателя
  status           String   @default("new") // new, processing, approved, rejected
  adminComment     String? // Комментарий администратора
  processedBy      String? // ID администратора, обработавшего заявку
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([email])
}

// Модель для жалоб на пользователей
model UserReport {
  id           String   @id @default(cuid())
  reporterId   String
  reporter     User     @relation("ReportReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reportedId   String
  reported     User     @relation("ReportReported", fields: [reportedId], references: [id], onDelete: Cascade)
  reason       String
  status       String   @default("pending") // pending, reviewed, resolved, dismissed
  adminComment String?
  processedBy  String? // ID администратора, обработавшего жалобу
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([reporterId])
  @@index([reportedId])
  @@index([status])
  @@index([createdAt])
}

// Модель для баг-репортов
model BugReport {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("BugReportAuthor", fields: [userId], references: [id], onDelete: Cascade)

  title        String // Краткое описание проблемы (до 40 символов)
  description  String // Подробное описание (до 700 символов)
  category     String  @default("MODERATOR") // MODERATOR, DEVELOPER, DESIGNER, OTHER
  status       String  @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  adminComment String? // Комментарий администратора
  processedBy  String? // ID администратора, обработавшего баг-репорт

  images BugReportImage[]
  likes  BugReportLike[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
}

model BugReportImage {
  id          String    @id @default(cuid())
  bugReportId String
  bugReport   BugReport @relation(fields: [bugReportId], references: [id], onDelete: Cascade)

  url  String
  sort Int    @default(0)

  @@index([bugReportId])
  @@index([sort])
}

model BugReportLike {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation("BugReportLikes", fields: [userId], references: [id], onDelete: Cascade)
  bugReportId String
  bugReport   BugReport @relation(fields: [bugReportId], references: [id], onDelete: Cascade)
  isLike      Boolean   @default(true) // true = лайк, false = дизлайк
  createdAt   DateTime  @default(now())

  @@unique([userId, bugReportId])
  @@index([userId])
  @@index([bugReportId])
  @@index([isLike])
}

// Модель для результатов игр
model GameScore {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  gameKey     String   @default("coin-catch") // например "coin-catch"
  weekKey     String   @default("2026-W05") // например "2026-W05"
  score       Int
  displayName String   @default("Игрок") // имя пользователя на момент записи
  createdAt   DateTime @default(now())

  @@index([gameKey])
  @@index([weekKey])
  @@index([userId])
  @@index([score])
  @@index([createdAt])
  @@index([gameKey, weekKey, score])
}
