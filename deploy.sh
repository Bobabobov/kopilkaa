#!/bin/bash

# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
set -e  # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ

echo "ğŸš€ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹..."

# ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
cd /opt/kopilkaa

echo "ğŸ“¥ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ´ Ğ¸Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ (Ğ±ĞµĞ· ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ²)..."
# Ğ’ĞĞ–ĞĞ:
# - ĞĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ Ğ½Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ¼ ĞºĞ¾Ğ´ Ñ€ÑƒĞºĞ°Ğ¼Ğ¸ (Ğ¸Ğ½Ğ°Ñ‡Ğµ git pull Ğ±ÑƒĞ´ĞµÑ‚ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ¾Ğ²Ğ°Ñ‚ÑŒ).
# - npm install Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ Ğ¼ĞµĞ½ÑÑ‚ÑŒ ĞĞ• Ğ½Ğ°Ğ´Ğ¾ (Ğ¾Ğ½Ğ¾ Ğ¼ĞµĞ½ÑĞµÑ‚ package-lock.json).
# - Ğ­Ñ‚Ğ¾Ñ‚ Ğ±Ğ»Ğ¾Ğº Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ñ‚ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğº ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ origin/main.
git fetch origin
git reset --hard origin/main

echo "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (npm ci, ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾ package-lock.json)..."
npm ci --no-audit --no-fund

echo "ğŸ§© Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¸ Ğ‘Ğ” Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ)..."
# Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° Ğ±Ñ‹Ğ»Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ (Ñ‡ĞµÑ€ĞµĞ· prisma db execute), Ğ¾Ñ‚Ğ¼ĞµÑ‡Ğ°ĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ğº Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½ÑƒÑ,
# Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ `migrate deploy` Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°Ğ» Ğ½Ğ° Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¼ ALTER TABLE.
if npx prisma migrate resolve --applied 20260103090000_add_hero_badge_override >/dev/null 2>&1; then
  echo "âœ… ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ 20260103090000_add_hero_badge_override Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ° ĞºĞ°Ğº Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ğ°Ñ"
else
  echo "â„¹ï¸  ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ 20260103090000_add_hero_badge_override ÑƒĞ¶Ğµ Ğ±Ñ‹Ğ»Ğ° Ğ¾Ñ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ° ĞºĞ°Ğº Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ğ°Ñ"
fi

echo "ğŸ—„ï¸  ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…..."
npx prisma migrate deploy

echo "ğŸ§¬ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Prisma Client..."
npx prisma generate

echo "ğŸ§¹ Ğ§Ğ¸ÑÑ‚Ğ¸Ğ¼ ĞºĞµÑˆ Next.js..."
rm -rf .next .turbo node_modules/.cache || true

echo "ğŸ”¨ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚..."
npm run build

echo "ğŸ”„ ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ¼..."
pm2 stop kopilka || true
sleep 2

echo "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ..."
if pm2 describe kopilka >/dev/null 2>&1; then
  pm2 delete kopilka || true
fi

pm2 start npm --name kopilka -- start
pm2 save || true

echo "âœ… Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!"
echo "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ:"
pm2 status kopilka || pm2 status

